function insertNewline(e){if(null!=e.selectionStart){var t=e.value.substring(0,e.selectionStart),i=figureIndent(t),n=e.selectionEnd,r=e.value.substring(e.selectionEnd,e.value.length),a=e.scrollTop;e.value=t+"\n"+i+r;var o=n+1+i.length;return e.selectionStart=o,e.selectionEnd=o,e.scrollTop=a,!1}if(document.selection&&document.selection.createRange){var l=document.selection.createRange(),s=l.duplicate();s.moveToElementText(e),s.setEndPoint("EndToEnd",l);var u=s.text.length-l.text.length,h=figureIndent(e.value.substring(0,u));return""==h||(l.text="\n"+h,!1)}return!0}function figureIndent(e){var t=e.lastIndexOf("\n"),n=e.substring(t+1),r="";for(i=0;i<n.length&&" "==n.charAt(i);i++)r+=" ";return r}function handleCR(e,t){return 13!=t.keyCode||insertNewline(e)}function extractLine(e,t){return e.inhibitLine?-1:e.line?e.line:e.lineNumber?e.lineNumber-t+1:-1}function evaluate(inID){var ta=document.getElementById(inID),preErr=preflightCheck(ta.value);if(preErr){var e=new Error;return e.message=preErr,e}var text=sugarCode(ta.value),evalLine=0,error=new Error;error.lineNumber&&(evalLine=error.lineNumber+3);try{let txtAlteraPrint=text.replace(/print/g,"printCode");eval(txtAlteraPrint)}catch(e){e.userError=!0;var line=extractLine(e,evalLine);return-1!=line&&(e.userLine=line),e}return null}function selectLine(e,t){if(e.setSelectionRange)for(var i=0,n=0,r=e.value,a=0;a<r.length;a++)if("\n"==r[a]||0!=n&&a==r.length-1)if(++i==t-1)n=a+1;else if(i==t)return e.focus(),void e.setSelectionRange(n,a)}function evaluateShow(e){try{var t=evaluate(e);if(null!=t){var i="<font color=red>Error:</font>"+t.message;if(t.userLine&&(i+=" line:"+t.userLine),printCode(i),t.userLine)selectLine(document.getElementById(e),t.userLine)}}catch(t){alert("Low level evaluation error:"+t)}}function evaluateClear(e){store(e),window.globalRunId=e,window.globalPrintCount=5e3,clearOutput(),preloadImages(document.getElementById(e).value),setTimeout((function(){evaluateShow(e)}),1e3)}var appendCount=0;function isAuxUrl(e){return e.length>=3&&"aux"==e.substring(0,3)}var globalImgDb={};function loadImage(e){var t=getOutput(),i="img"+appendCount;if(appendCount++,e in globalImgDb)e=globalImgDb[e];else if(isAuxUrl(e)){-1!=e.indexOf(".jpg")&&(e=e.substring(0,e.indexOf(".jpg")));var n=document.getElementById(e).value;!n||n.length>=5&&"data:"==n.substring(0,5)||(n="data:image/jpeg;base64,"+n),(!n||n.length<20)&&throwError("Trying to load aux image '"+e+"' but no data found"),e=n}var r=new Image;return r.setAttribute("id",i),r.setAttribute("src",e),r.setAttribute("style","display:none"),t.appendChild(r),r}function printCode(){if(window.globalPrintCount<=0)0==window.globalPrintCount&&(printOne("***print output limited***"),printOne("<br>"),window.globalPrintCount--);else{window.globalPrintCount--;for(var e=0;e<arguments.length;e++)printOne(arguments[e]);printOne("<br>")}}function printStart(){for(var e=0;e<arguments.length;e++)printOne(arguments[e])}function getOutput(){return document.getElementById(window.globalRunId+"-output")}function printOne(e){var t=getOutput();if(e.getString&&(e=e.getString()),e instanceof Array&&(e="["+e.join(", ")+"]"),"string"==typeof e||"number"==typeof e){var i=document.createElement("text"),n=" ";"<br>"==e&&(n=""),i.innerHTML=e+n,t.appendChild(i)}else if(e instanceof HTMLImageElement){var r=e.cloneNode(!0);r.setAttribute("style",""),r.setAttribute("id",""),t.appendChild(r)}else if(e instanceof SimpleImage){var a="canvas"+appendCount;appendCount++;var o=document.createElement("canvas");o.setAttribute("id",a),e.drawTo(o),t.appendChild(o)}else alert("bad print with:"+e)}function clearOutput(){getOutput().innerHTML=""}function clearOutputId(e){var t=document.getElementById(e+"-output");if(!t){var i=new Error;throw i.message="clearOutput() with bad id "+e,i.inhibitLine=!0,i}t.innerHTML=""}function getArray(e){if(e&&"object"==typeof e){if(e instanceof Array)return e;if("toArray"in e)return e.toArray()}else throwError("'for (part: composite)' used, but composite is wrong.")}function sugarCode(e){for(var t,i=/for *\([ \w+().-]*:[ \w+().-]*\) *\{/g,n=/for\s*\(\s*(?:var\s+)?(\w+)\s*:\s*(\w+(\(.*?\))?)\s*\)\s*\{/;null!=(t=i.exec(e));){-1==t[0].search(n)&&throwError("Attempt to use 'for(part: composite)' form, but it looks wrong: "+t[0])}for(var r=0;;){var a=e,o="pxyz"+r,l="ixyz"+r;r++;var s="var "+o+" = getArray($2); for (var "+l+"=0; "+l+"<"+o+".length; "+l+"++) {var $1 = "+o+"["+l+"];";if((e=e.replace(n,s))==a)break}return e}function throwError(e){var t=new Error;throw t.message=e,t.inhibitLine=!0,t}function funCheck(e,t,i){t!=i&&throwError(e+"() called with "+i+" value"+(1==i?"":"s")+", but expected "+t+" value"+(1==t?"":"s")+".")}function preloadImages(e){for(var t=/SimpleImage\(\s*("|')(.*?)("|')\s*\)/g;ar=t.exec(e);){loadImage(ar[2])}}function clamp(e){return e<0?0:e>255?255:e}SimpleImage=function(e){var t=null;if("string"==typeof e)t=loadImage(e);else{if(!(e instanceof HTMLImageElement)){var i=new Error;throw i.message="new SimpleImage(...) requires a htmlImage.",i.inhibitLine=!0,i}t=e}var n=getOutput(),r="canvas"+appendCount;appendCount++;var a=document.createElement("canvas");a.setAttribute("id",r),a.setAttribute("style","display:none"),n.appendChild(a),t.complete||alert("Image loading -- may need to run again"),this.width=t.width,this.height=t.height,this.canvas=a,this.canvas.width=this.width,this.canvas.height=this.height,this.context=a.getContext("2d"),this.drawFrom(t),this.imageData=this.context.getImageData(0,0,this.width,this.height)},SimpleImage.prototype.canvas,SimpleImage.prototype.context,SimpleImage.prototype.width,SimpleImage.prototype.height,SimpleImage.prototype.imageData,SimpleImage.prototype.zoom,SimpleImage.prototype.setZoom=function(e){this.zoom=e},SimpleImage.prototype.setSize=function(e,t){var i=getOutput(),n="canvas"+appendCount;appendCount++;var r=document.createElement("canvas");r.width=e,r.height=t,r.setAttribute("id",n),r.setAttribute("style","display:none");var a=document.createElement("text");a.appendChild(r),i.appendChild(a),this.flush(),r.getContext("2d").drawImage(this.canvas,0,0,e,t),this.width=r.width,this.height=r.height,this.canvas=r,this.context=r.getContext("2d"),this.imageData=this.context.getImageData(0,0,this.width,this.height)},SimpleImage.prototype.setSameSize=function(e){if(this.width){var t=e.width/this.width,i=e.height/this.height,n=Math.max(t,i);1!=n&&this.setSize(this.width*n,this.height*n)}},SimpleImage.prototype.drawFrom=function(e){this.context.drawImage(e,0,0)},SimpleImage.prototype.drawTo=function(e){this.zoom?(e.width=this.width*this.zoom,e.height=this.height*this.zoom):(e.width=this.width,e.height=this.height),this.flush();var t=e.getContext("2d");if(this.zoom){for(var i=t.createImageData(e.width,e.height),n=0;n<e.width;n++)for(var r=0;r<e.height;r++)for(var a=4*(n+r*e.width),o=4*(Math.floor(n/this.zoom)+Math.floor(r/this.zoom)*this.width),l=0;l<4;l++)i.data[a+l]=this.imageData.data[o+l];t.putImageData(i,0,0)}else t.drawImage(this.canvas,0,0)},SimpleImage.prototype.getWidth=function(){return this.width},SimpleImage.prototype.getHeight=function(){return this.height},SimpleImage.prototype.getIndex=function(e,t){var i;if(null==e||null==t)throw(i=new Error("need x and y values passed to this function")).inhibitLine=!0,i;if(e<0||e>=this.width||t<0||t>=this.height)throw(i=new Error("x/y out of bounds x:"+e+" y:"+t)).inhibitLine=!0,i;return 4*(e+t*this.width)},SimpleImage.prototype.setRed=function(e,t,i){funCheck("setRed",3,arguments.length);var n=this.getIndex(e,t);this.imageData.data[n]=clamp(i)},SimpleImage.prototype.setGreen=function(e,t,i){funCheck("setGreen",3,arguments.length);var n=this.getIndex(e,t);this.imageData.data[n+1]=clamp(i)},SimpleImage.prototype.setBlue=function(e,t,i){funCheck("setBlue",3,arguments.length);var n=this.getIndex(e,t);this.imageData.data[n+2]=clamp(i)},SimpleImage.prototype.setAlpha=function(e,t,i){funCheck("setAlpha",3,arguments.length);var n=this.getIndex(e,t);this.imageData.data[n+3]=clamp(i)},SimpleImage.prototype.getRed=function(e,t){funCheck("getRed",2,arguments.length);var i=this.getIndex(e,t);return this.imageData.data[i]},SimpleImage.prototype.getGreen=function(e,t){funCheck("getGreen",2,arguments.length);var i=this.getIndex(e,t);return this.imageData.data[i+1]},SimpleImage.prototype.getBlue=function(e,t){funCheck("getBlue",2,arguments.length);var i=this.getIndex(e,t);return this.imageData.data[i+2]},SimpleImage.prototype.getAlpha=function(e,t){funCheck("getAlpha",2,arguments.length);var i=this.getIndex(e,t);return this.imageData.data[i+3]},SimpleImage.prototype.getPixel=function(e,t){return funCheck("getPixel",2,arguments.length),new SimplePixel(this,e,t)},SimpleImage.prototype.flush=function(){this.context.putImageData(this.imageData,0,0)},SimpleImage.prototype.toArray=function(){for(var e=new Array,t=0;t<this.getHeight();t++)for(var i=0;i<this.getWidth();i++)e.push(new SimplePixel(this,i,t));return e},SimplePixel=function(e,t,i){this.simple_image=e,this.x=t,this.y=i},SimplePixel.prototype.simple_image,SimplePixel.prototype.x,SimplePixel.prototype.y,SimplePixel.prototype.getRed=function(){return funCheck("getRed",0,arguments.length),this.simple_image.getRed(this.x,this.y)},SimplePixel.prototype.setRed=function(e){funCheck("setRed",1,arguments.length),this.simple_image.setRed(this.x,this.y,e)},SimplePixel.prototype.getGreen=function(){return funCheck("getGreen",0,arguments.length),this.simple_image.getGreen(this.x,this.y)},SimplePixel.prototype.setGreen=function(e){funCheck("setGreen",1,arguments.length),this.simple_image.setGreen(this.x,this.y,e)},SimplePixel.prototype.getBlue=function(){return funCheck("getBlue",0,arguments.length),this.simple_image.getBlue(this.x,this.y)},SimplePixel.prototype.setBlue=function(e){funCheck("setBlue",1,arguments.length),this.simple_image.setBlue(this.x,this.y,e)},SimplePixel.prototype.getX=function(){return funCheck("getX",0,arguments.length),this.x},SimplePixel.prototype.getY=function(){return funCheck("getY",0,arguments.length),this.y},SimplePixel.prototype.getString=function(){return"r:"+this.getRed()+" g:"+this.getGreen()+" b:"+this.getBlue()};var storeprefix="citb.",storeexpattern=".-ex";function store(e){if(localStorage&&!window.storeinhibit&&e.match(storeexpattern)){var t=document.getElementById(e).value,i=t.replace(/\s/g,"");i.length>0&&("del"==i&&(t=""),localStorage.setItem(storeprefix+e,t))}}function retrieve(e){if(!localStorage)return"";if(window.storeinhibit)return"";var t=localStorage.getItem(storeprefix+e);return t||(t=""),t}function retrieveCodeText(e){if(localStorage&&!window.storeinhibit){for(var t=new Array,i=0;i<localStorage.length;i++){0==(r=localStorage.key(i)).indexOf(storeprefix)&&t.push(r)}t.sort();var n="";for(var i in t){var r=t[i],a=localStorage.getItem(r);n=n+"----------\n"+r.substring(storeprefix.length)+"\n\n"+a+"\n"}if(e)document.getElementById(e).innerHTML="<pre>"+n+"</pre>";return n}}function retrieveCodeTextIds(e,t){if(localStorage&&!window.storeinhibit){t.sort();var i="";for(var n in t){var r=retrieve(t[n]);i=i+"----------\n"+t[n]+"\n\n"+r+"\n"}if(e)document.getElementById(e).innerHTML="<pre>"+i+"</pre>";return i}}function preflightCheck(e){if(window.nocodecheck)return"";for(var t,i=/^\s*if\s*(.*)$/gm;null!=(t=i.exec(e));){var n="",r="";if((l=t[1]).match(/\{\s*($|\/\/)/))n=l,r=l;else{var a=e.substring(t.index);null!=(result2=/^\s*if\s*((.*(\r?\n?)){1,3}.*\{\s*($|\/\/))/m.exec(a))&&(n=result2[1],r=result2[0])}if(!n)return"<b>if-statement</b> cannot find end of line <br>left curly brace <b>{</b> <br>Form should be <br><b>if (test) {</b><br>&nbsp;..code..<br>but found:"+t[0];if(!n.match(/^\s*\(/))return"<b>if</b> should be immediately followed by <b>(</b>test<b>)</b> but found:<br>"+r;if(!n.match(/\)\s*\{\s*($|\/\/)/))return"<b>if test</b> should end with <b>)</b> but found:<br>"+r;if(n.match(/[^<>=!]\=[^=]/))return"<b>if test</b> should not contain single = (use == &lt;= &gt;=), but found:<br>"+r;if(n.match(/[^&]&[^&]/))return"<b>if test</b> should not contain single & (use double &&), but found:<br>"+r;if(n.match(/[^|]\|[^|]/))return"<b>if test</b> should not contain single | (use double ||), but found:<br>"+r}for(var o=/^\s*for\s(.*)$/gm;null!=(t=o.exec(e));){var l;if(!(l=t[1]).match(/^\s*\(/))return"<b>for</b> should be immediately followed by <b>(</b> but found:<br>"+t[0];if(!l.match(/\{\s*($|\/\/)/))return"<b>for</b> line should end with curly brace <b>{</b> but found:<br>"+t[0];if(!l.match(/\)\s*\{\s*($|\/\/)/))return"<b>for</b> should be followed by <b>(</b>part: whole<b>)</b> but found:<br>"+t[0]}for(var s=/(getRed|getGreen|getBlue|setRed|setGreen|setBlue|getX|getY|getPixel|setZoom|setSize|setSameSize|getField|startsWith|endsWith)(.)/g,u=/(getRed|getGreen|getBlue|setRed|setGreen|setBlue|getX|getY|getPixel|setZoom|setSize|setSameSize|getField|startsWith|endsWith)(.)/gi;null!=(t=u.exec(e));)if(!t[0].match(s))return"<b>"+t[1]+"</b> appears to have some wrong capitalization";for(;null!=(t=s.exec(e));){if("("!=t[2])return"<b>"+t[1]+"</b> should be immediately followed by <b>(</b>"}return""}function unhide(e){e.style.display="none",e.nextSibling.style.display="block"}